pipeline{
	agent any
	stages {
		stage('Checkout') {
            		steps {
                		checkout([$class: 'GitSCM', branches: [[name: '*/main']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'jenkins-user-github', url: 'https://github.com/aarathytraining/mysite-react.git']]])
                		sh "ls -lart ./*"
            		}
        	}
		
		stage('Build'){
			steps{
				sh 'npm install'
				sh 'npm run build'
			}
		}
		
		stage('Test'){
			steps{
				sh 'npm test -- --watchAll=false'
			}
		}
		
		stage('Create Image & push'){
			steps{
				sh 'docker -H :2376 build -t aarathytraining/mysite-react:v1 . && docker -H :2376 push aarathytraining/mysite-react:v1'
			}
		}
		
		stage('Deploy image to docker'){
			steps{
				sh "ssh -o StrictHostKeyChecking=no -i /home/ubuntu/jenkins02.pem ubuntu@ec2-54-237-223-224.compute-1.amazonaws.com 'sudo docker stop mysite-react-page && sudo docker rm mysite-react-page && sudo docker run --name mysite-react-page -itd -p 3000:80 aarathytraining/mysite-react:v1'"
			}
		}
		stage('End of job'){
			steps{
				sh 'echo "end of pipeline"'
			}
		}
	}
}
